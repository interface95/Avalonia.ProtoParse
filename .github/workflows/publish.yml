name: Build and Release

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.rid }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - rid: win-x64
            os: windows-latest
            output-name: Avalonia.ProtoParse-win-x64.exe
          - rid: win-x86
            os: windows-latest
            output-name: Avalonia.ProtoParse-win-x86.exe
          - rid: osx-x64
            os: macos-latest
            output-name: Avalonia.ProtoParse-mac-x64
          - rid: osx-arm64
            os: macos-latest
            output-name: Avalonia.ProtoParse-mac-arm64

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 10.0.x

    - name: Restore Dependencies
      run: dotnet restore Avalonia.ProtoParse.Desktop/Avalonia.ProtoParse.Desktop.csproj

    - name: Build (Non-Tag)
      if: "!startsWith(github.ref, 'refs/tags/')"
      run: dotnet build Avalonia.ProtoParse.Desktop/Avalonia.ProtoParse.Desktop.csproj -c Release

    - name: Publish AOT (Tag Only)
      if: startsWith(github.ref, 'refs/tags/')
      run: dotnet publish Avalonia.ProtoParse.Desktop/Avalonia.ProtoParse.Desktop.csproj -c Release -r ${{ matrix.rid }} -o publish/${{ matrix.rid }}

    # Compress artifacts
    - name: Compress (Windows)
      if: startsWith(github.ref, 'refs/tags/') && runner.os == 'Windows'
      run: |
        cd publish/${{ matrix.rid }}
        Compress-Archive -Path * -DestinationPath ../../Avalonia.ProtoParse-${{ matrix.rid }}.zip

    - name: Compress (macOS)
      if: startsWith(github.ref, 'refs/tags/') && runner.os == 'macOS'
      run: |
        cd publish/${{ matrix.rid }}
        # Ensure executable permission
        chmod +x Avalonia.ProtoParse.Desktop
        # Create a simple app bundle structure or just zip the executable
        zip -r ../../Avalonia.ProtoParse-${{ matrix.rid }}.zip .

    - name: Upload Artifact
      if: startsWith(github.ref, 'refs/tags/')
      uses: actions/upload-artifact@v4
      with:
        name: Avalonia.ProtoParse-${{ matrix.rid }}
        path: Avalonia.ProtoParse-${{ matrix.rid }}.zip

  release:
    name: Create Release
    if: startsWith(github.ref, 'refs/tags/')
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4

    - name: Download Artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Resolve Release Token
      id: release_token
      shell: bash
      env:
        CUSTOM_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        DEFAULT_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        if [ -n "$CUSTOM_TOKEN" ]; then
          echo "value=$CUSTOM_TOKEN" >> "$GITHUB_OUTPUT"
        else
          echo "value=$DEFAULT_TOKEN" >> "$GITHUB_OUTPUT"
        fi

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        token: ${{ steps.release_token.outputs.value }}
        files: artifacts/**/*.zip
        draft: false
        prerelease: false
        generate_release_notes: true
