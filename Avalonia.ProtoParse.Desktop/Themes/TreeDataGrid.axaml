<Styles xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:conv="using:Avalonia.Controls.Converters"
        xmlns:localConv="using:Avalonia.ProtoParse.Desktop.Converters"
        xmlns:core="clr-namespace:Avalonia.ProtoParse.Desktop.Core">

    <Styles.Resources>
        <ResourceDictionary>
            <localConv:ParentNodeBackgroundConverter x:Key="ParentNodeBackgroundConverter" />
            <localConv:ParentNodeBorderBrushConverter x:Key="ParentNodeBorderBrushConverter" />
            <localConv:ParentNodeBorderThicknessConverter x:Key="ParentNodeBorderThicknessConverter" />
            <localConv:HasChildrenConverter x:Key="HasChildrenConverter" />

            <localConv:WireTypeToBrushConverter x:Key="WireTypeToBrushConverter" />

            <DataTemplate x:Key="ProtoNodeTemplate" DataType="core:ProtoDisplayNode">
                <Border CornerRadius="4" Padding="4,2" Classes.highlighted="{Binding IsHighlighted}"
                        Background="Transparent">
                    <Grid ColumnDefinitions="Auto, Auto, *" Tag="{Binding WireType}">
                        <Grid.Styles>
                            <Style Selector="Grid[Tag=Varint] TextBlock">
                                <Setter Property="Foreground" Value="{DynamicResource WireTypeVarintBrush}" />
                            </Style>
                            <Style Selector="Grid[Tag=Fixed32] TextBlock">
                                <Setter Property="Foreground" Value="{DynamicResource WireTypeFixedBrush}" />
                            </Style>
                            <Style Selector="Grid[Tag=Fixed64] TextBlock">
                                <Setter Property="Foreground" Value="{DynamicResource WireTypeFixedBrush}" />
                            </Style>
                            <Style Selector="Grid[Tag=LengthDelimited] TextBlock">
                                <Setter Property="Foreground" Value="{DynamicResource WireTypeLengthDelimitedBrush}" />
                            </Style>
                            <!-- Default/Fallback -->
                            <Style Selector="Grid TextBlock">
                                <Setter Property="Foreground" Value="{DynamicResource WireTypeDefaultBrush}" />
                            </Style>
                        </Grid.Styles>

                        <Border Classes="field-badge" Grid.Column="0"
                                MinWidth="28"
                                Height="25"
                                CornerRadius="12"
                                Background="{DynamicResource BadgeBackground}"
                                Margin="0,0,10,0">
                            <TextBlock Text="{Binding FieldDisplay}"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center"
                                       Padding="4,0"
                                       Foreground="{DynamicResource BadgeForeground}" />
                        </Border>
                        <TextBlock Grid.Column="1"
                                   Text="{Binding WireTypeDisplay}"
                                   VerticalAlignment="Center"
                                   Margin="0,0,10,0" />
                        <TextBlock Grid.Column="2"
                                   Text="{Binding Summary}"
                                   VerticalAlignment="Center"
                                   Margin="0,0,5,0" TextTrimming="CharacterEllipsis" />
                    </Grid>
                </Border>
            </DataTemplate>

            <StreamGeometry x:Key="TreeDataGridSortIconDescendingPath">M1875 1011l-787 787v-1798h-128v1798l-787 -787l-90 90l941 941l941 -941z</StreamGeometry>
            <StreamGeometry x:Key="TreeDataGridSortIconAscendingPath">M1965 947l-941 -941l-941 941l90 90l787 -787v1798h128v-1798l787 787z</StreamGeometry>
            <StreamGeometry x:Key="TreeDataGridItemCollapsedChevronPathData">M 1,0 10,10 l -9,10 -1,-1 L 8,10 -0,1 Z</StreamGeometry>
            <StreamGeometry x:Key="TreeDataGridItemExpandedChevronPathData">M0,1 L10,10 20,1 19,0 10,8 1,0 Z</StreamGeometry>

            <ControlTheme x:Key="{x:Type TreeDataGrid}" TargetType="TreeDataGrid">
                <Setter Property="Template">
                    <ControlTemplate>
                        <Border x:Name="RootBorder"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="{TemplateBinding CornerRadius}">
                            <DockPanel>
                                <ScrollViewer Name="PART_HeaderScrollViewer"
                                              DockPanel.Dock="Top"
                                              IsVisible="{TemplateBinding ShowColumnHeaders}"
                                              HorizontalScrollBarVisibility="Hidden"
                                              VerticalScrollBarVisibility="Disabled"
                                              BringIntoViewOnFocusChange="{TemplateBinding (ScrollViewer.BringIntoViewOnFocusChange)}">
                                    <Border x:Name="ColumnHeadersPresenterBorder">
                                        <TreeDataGridColumnHeadersPresenter Name="PART_ColumnHeadersPresenter"
                                                                            ElementFactory="{TemplateBinding ElementFactory}"
                                                                            Items="{TemplateBinding Columns}" />
                                    </Border>
                                </ScrollViewer>
                                <ScrollViewer Name="PART_ScrollViewer"
                                              HorizontalScrollBarVisibility="Auto"
                                              VerticalScrollBarVisibility="Auto"
                                              BringIntoViewOnFocusChange="{TemplateBinding (ScrollViewer.BringIntoViewOnFocusChange)}">
                                    <TreeDataGridRowsPresenter Name="PART_RowsPresenter"
                                                               Columns="{TemplateBinding Columns}"
                                                               ElementFactory="{TemplateBinding ElementFactory}"
                                                               Items="{TemplateBinding Rows}" />
                                </ScrollViewer>
                            </DockPanel>
                        </Border>
                    </ControlTemplate>
                </Setter>

                <Style Selector="^/template/ Border#ColumnHeadersPresenterBorder">
                    <Setter Property="BorderThickness" Value="0 0 0 1" />
                    <Setter Property="BorderBrush" Value="{DynamicResource TreeDataGridGridLinesBrush}" />
                </Style>

            </ControlTheme>

            <ControlTheme x:Key="{x:Type TreeDataGridColumnHeader}" TargetType="TreeDataGridColumnHeader">
                <Setter Property="Background" Value="Transparent" />
                <Setter Property="MinHeight" Value="25" />
                <Setter Property="Padding" Value="4 2" />
                <Setter Property="VerticalContentAlignment" Value="Center" />
                <Setter Property="Template">
                    <ControlTemplate>
                        <Border Name="DataGridBorder"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="{TemplateBinding CornerRadius}">
                            <DockPanel VerticalAlignment="Stretch">
                                <Panel DockPanel.Dock="Right"
                                       TabIndex="2">
                                    <Rectangle Fill="{DynamicResource TreeDataGridGridLinesBrush}"
                                               HorizontalAlignment="Right"
                                               Width="1" />
                                    <Thumb Name="PART_Resizer"
                                           DockPanel.Dock="Right"
                                           Background="Transparent"
                                           Cursor="SizeWestEast"
                                           IsVisible="{TemplateBinding CanUserResize}"
                                           Width="5">
                                        <Thumb.Template>
                                            <ControlTemplate>
                                                <Border Background="{TemplateBinding Background}"
                                                        VerticalAlignment="Stretch" />
                                            </ControlTemplate>
                                        </Thumb.Template>
                                    </Thumb>
                                </Panel>
                                <Path Name="SortIcon"
                                      DockPanel.Dock="Right"
                                      Fill="{TemplateBinding Foreground}"
                                      HorizontalAlignment="Center"
                                      VerticalAlignment="Center"
                                      Stretch="Uniform"
                                      Height="12"
                                      TabIndex="1" />
                                <ContentPresenter Name="PART_ContentPresenter"
                                                  Content="{TemplateBinding Header}"
                                                  ContentTemplate="{TemplateBinding ContentTemplate}"
                                                  Padding="{TemplateBinding Padding}"
                                                  HorizontalContentAlignment="{TemplateBinding HorizontalContentAlignment}"
                                                  VerticalContentAlignment="{TemplateBinding VerticalContentAlignment}"
                                                  TabIndex="0">
                                    <ContentPresenter.DataTemplates>
                                        <DataTemplate DataType="x:String">
                                            <TextBlock Text="{Binding}" TextTrimming="CharacterEllipsis" />
                                        </DataTemplate>
                                    </ContentPresenter.DataTemplates>
                                </ContentPresenter>
                            </DockPanel>
                        </Border>
                    </ControlTemplate>
                </Setter>

                <Style Selector="^:pointerover /template/ Border#DataGridBorder">
                    <Setter Property="Background"
                            Value="{DynamicResource TreeDataGridHeaderBackgroundPointerOverBrush}" />
                    <Setter Property="BorderBrush"
                            Value="{DynamicResource TreeDataGridHeaderBorderBrushPointerOverBrush}" />
                    <Setter Property="TextBlock.Foreground"
                            Value="{DynamicResource TreeDataGridHeaderForegroundPointerOverBrush}" />
                </Style>

                <Style Selector="^:pressed /template/ Border#DataGridBorder">
                    <Setter Property="Background" Value="{DynamicResource TreeDataGridHeaderBackgroundPressedBrush}" />
                    <Setter Property="BorderBrush" Value="{DynamicResource TreeDataGridHeaderBorderBrushPressedBrush}" />
                    <Setter Property="TextBlock.Foreground"
                            Value="{DynamicResource TreeDataGridHeaderForegroundPressedBrush}" />
                </Style>

                <Style Selector="^[SortDirection=Ascending] /template/ Path#SortIcon">
                    <Setter Property="IsVisible" Value="True" />
                    <Setter Property="Data" Value="{DynamicResource TreeDataGridSortIconAscendingPath}" />
                </Style>

                <Style Selector="^[SortDirection=Descending] /template/ Path#SortIcon">
                    <Setter Property="IsVisible" Value="True" />
                    <Setter Property="Data" Value="{DynamicResource TreeDataGridSortIconDescendingPath}" />
                </Style>

            </ControlTheme>

            <!-- 
    TreeDataGridRow 样式
    定义了行的基本外观和选中/悬停状态
  -->
            <ControlTheme x:Key="{x:Type TreeDataGridRow}" TargetType="TreeDataGridRow">
                <Setter Property="Template">
                    <ControlTemplate>
                        <Border x:Name="RowBorder"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="{TemplateBinding CornerRadius}">
                            <TreeDataGridCellsPresenter Name="PART_CellsPresenter"
                                                        ElementFactory="{TemplateBinding ElementFactory}"
                                                        Items="{TemplateBinding Columns}"
                                                        Rows="{TemplateBinding Rows}" />
                        </Border>
                    </ControlTemplate>
                </Setter>

                <!-- 选中时，移除 CellsPresenter 的背景，以便让底层的 Border#HoverBorder 显示出来 -->
                <Style Selector="^:selected /template/ TreeDataGridCellsPresenter#PART_CellsPresenter">
                    <Setter Property="Background" Value="Transparent" />
                </Style>
                <!-- 悬停时，移除 CellsPresenter 的背景 -->
                <Style Selector="^:pointerover /template/ TreeDataGridCellsPresenter#PART_CellsPresenter">
                    <Setter Property="Background" Value="Transparent" />
                </Style>

            </ControlTheme>

            <!-- TreeDataGridCheckBoxCell 样式 -->
            <ControlTheme x:Key="{x:Type TreeDataGridCheckBoxCell}" TargetType="TreeDataGridCheckBoxCell">
                <Setter Property="Padding" Value="4 2" />
                <Setter Property="Template">
                    <ControlTemplate>
                        <Border x:Name="CellBorder"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="{TemplateBinding CornerRadius}"
                                Padding="{TemplateBinding Padding}">
                            <CheckBox IsChecked="{TemplateBinding Value, Mode=TwoWay}"
                                      IsEnabled="{Binding !IsReadOnly, RelativeSource={RelativeSource TemplatedParent}}"
                                      IsThreeState="{TemplateBinding IsThreeState}" />
                        </Border>
                    </ControlTemplate>
                </Setter>
            </ControlTheme>

            <!-- 展开/折叠箭头样式 -->
            <ControlTheme x:Key="TreeDataGridExpandCollapseChevron" TargetType="ToggleButton">
                <Setter Property="Margin" Value="0" />
                <Setter Property="Width" Value="17" />
                <Setter Property="Height" Value="17" />
                <Setter Property="Template">
                    <ControlTemplate>
                        <Border Background="{DynamicResource ExpanderBackground}"
                                BorderBrush="{DynamicResource ExpanderBorder}"
                                BorderThickness="1"
                                CornerRadius="4"
                                Width="{TemplateBinding Width}"
                                Height="{TemplateBinding Height}"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center">
                            <Viewbox Width="8" Height="8"
                                     HorizontalAlignment="Center"
                                     VerticalAlignment="Center">
                                <Path x:Name="ChevronPath"
                                      Data="{StaticResource TreeDataGridItemCollapsedChevronPathData}"
                                      Fill="{DynamicResource ExpanderForeground}"
                                      Stretch="Uniform" />
                            </Viewbox>
                        </Border>
                    </ControlTemplate>
                </Setter>
                <Style Selector="^:checked /template/ Path#ChevronPath">
                    <Setter Property="Data" Value="{StaticResource TreeDataGridItemExpandedChevronPathData}" />
                </Style>
            </ControlTheme>

            <!-- 
    TreeDataGridExpanderCell 样式 (核心样式)
    包含展开/折叠按钮和节点内容
  -->
            <ControlTheme x:Key="{x:Type TreeDataGridExpanderCell}" TargetType="TreeDataGridExpanderCell">
                <Setter Property="Focusable" Value="False" />
                <Setter Property="Template">
                    <ControlTemplate>
                        <Border x:Name="CellBorder"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="{TemplateBinding CornerRadius}"
                                Padding="{TemplateBinding Indent, Converter={x:Static conv:IndentConverter.Instance}}">
                            <!-- 使用透明背景的 Panel 确保点击事件能被捕获 -->
                            <Panel Background="Transparent">
                                <!-- 基础背景层 (根据是否有子节点显示不同背景) -->
                                <Border x:Name="ContentBorder"
                                        x:DataType="core:ProtoDisplayNode"
                                        Classes.parent="{Binding Children.Count, Converter={StaticResource HasChildrenConverter}}"
                                        BorderThickness="{Binding Converter={StaticResource ParentNodeBorderThicknessConverter}}"
                                        CornerRadius="6"
                                        MinHeight="47"
                                        Margin="10,2" />

                                <!-- 悬停/选中/高亮 叠加层 -->
                                <Border x:Name="HoverBorder"
                                        x:CompileBindings="False"
                                        x:DataType="core:ProtoDisplayNode"
                                        Classes.highlighted="{Binding IsHighlighted}"
                                        CornerRadius="6"
                                        MinHeight="47"
                                        Margin="10,2"
                                        BorderThickness="1"
                                        Opacity="0"
                                        IsHitTestVisible="False">
                                    <Border.Transitions>
                                        <Transitions>
                                            <DoubleTransition Property="Opacity" Duration="0:0:0.1" />
                                        </Transitions>
                                    </Border.Transitions>
                                </Border>

                                <!-- 内容层 -->
                                <DockPanel Margin="20,2">
                                    <!-- 展开/折叠按钮 -->
                                    <Border DockPanel.Dock="Left"
                                            Margin="12,0,24,0"
                                            VerticalAlignment="Center"
                                            Width="18" Height="18">
                                        <ToggleButton Theme="{StaticResource TreeDataGridExpandCollapseChevron}"
                                                      Focusable="False"
                                                      IsChecked="{TemplateBinding IsExpanded, Mode=TwoWay}"
                                                      IsVisible="{TemplateBinding ShowExpander}" />
                                    </Border>
                                    <!-- 节点内容 (由 DataTemplate 定义) -->
                                    <Decorator Name="PART_Content" />
                                </DockPanel>
                            </Panel>
                        </Border>
                    </ControlTemplate>
                </Setter>

                <!-- 基础背景层样式：默认透明 -->
                <Style Selector="^ /template/ Border#ContentBorder" x:DataType="core:ProtoDisplayNode">
                    <Setter Property="Background" Value="Transparent" />
                    <Setter Property="BorderBrush" Value="Transparent" />
                </Style>

                <!-- 父节点样式：使用动态资源设置背景和边框 -->
                <Style Selector="^ /template/ Border#ContentBorder.parent" x:DataType="core:ProtoDisplayNode">
                    <Setter Property="Background" Value="{DynamicResource ParentNodeBackground}" />
                    <Setter Property="BorderBrush" Value="{DynamicResource ParentNodeBorder}" />
                </Style>

                <!-- 鼠标悬停状态：显示 HoverBorder -->
                <Style Selector="^:pointerover /template/ Border#HoverBorder">
                    <Setter Property="Opacity" Value="1" />
                    <Setter Property="Background" Value="{DynamicResource TreeDataGridSelectedCellBackgroundBrush}" />
                    <Setter Property="BorderBrush" Value="{DynamicResource TreeDataGridSelectedCellBackgroundBrush}" />
                </Style>

                <!-- 选中状态：显示 HoverBorder -->
                <Style Selector="^:selected /template/ Border#HoverBorder">
                    <Setter Property="Opacity" Value="1" />
                    <Setter Property="Background" Value="{DynamicResource TreeDataGridSelectedCellBackgroundBrush}" />
                    <Setter Property="BorderBrush" Value="{DynamicResource TreeDataGridSelectedCellBackgroundBrush}" />
                </Style>

                <!-- 搜索高亮状态：显示绿色边框和阴影 -->
                <Style Selector="^ /template/ Border#HoverBorder.highlighted">
                    <Setter Property="Opacity" Value="1" />
                    <Setter Property="Background" Value="{DynamicResource SearchHighlightBackground}" />
                    <Setter Property="BorderBrush" Value="{DynamicResource SearchHighlightBorder}" />
                    <Setter Property="BoxShadow" Value="{DynamicResource SearchHighlightShadow}" />
                </Style>

                <!-- 选中且高亮状态：保持高亮样式，覆盖选中样式 -->
                <Style Selector="^:selected /template/ Border#HoverBorder.highlighted">
                    <Setter Property="Background" Value="{DynamicResource SearchHighlightBackground}" />
                    <Setter Property="BorderBrush" Value="{DynamicResource SearchHighlightBorder}" />
                </Style>
            </ControlTheme>

            <!-- TreeDataGridTextCell 样式 -->
            <ControlTheme x:Key="{x:Type TreeDataGridTextCell}" TargetType="TreeDataGridTextCell">
                <Setter Property="Padding" Value="4 2" />
                <Setter Property="Template">
                    <ControlTemplate>
                        <Border x:Name="CellBorder"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="{TemplateBinding CornerRadius}"
                                Padding="{TemplateBinding Padding}">
                            <TextBlock Text="{TemplateBinding Value}"
                                       TextTrimming="{TemplateBinding TextTrimming}"
                                       TextWrapping="{TemplateBinding TextWrapping}"
                                       TextAlignment="{TemplateBinding TextAlignment}"
                                       VerticalAlignment="Center" />
                        </Border>
                    </ControlTemplate>
                </Setter>

                <Style Selector="^:editing">
                    <Setter Property="Padding" Value="4 2" />
                    <Setter Property="Template">
                        <ControlTemplate>
                            <Border x:Name="CellBorder"
                                    Background="{TemplateBinding Background}"
                                    BorderBrush="{TemplateBinding BorderBrush}"
                                    BorderThickness="{TemplateBinding BorderThickness}"
                                    CornerRadius="{TemplateBinding CornerRadius}"
                                    Padding="{TemplateBinding Padding}">
                                <TextBox Name="PART_Edit"
                                         Text="{TemplateBinding Value, Mode=TwoWay}" />
                            </Border>
                        </ControlTemplate>
                    </Setter>
                </Style>

                <Style Selector="^:editing /template/ TextBox#PART_Edit">
                    <Setter Property="Background" Value="Transparent" />
                    <Setter Property="MinHeight" Value="25" />
                    <Setter Property="Padding" Value="10,3,6,3" />
                    <Setter Property="VerticalAlignment" Value="Center" />
                </Style>

                <Style Selector="^:editing /template/ TextBox#PART_Edit DataValidationErrors">
                    <Setter Property="Template" Value="{DynamicResource TooltipDataValidationContentTemplate}" />
                    <Setter Property="ErrorTemplate" Value="{DynamicResource TooltipDataValidationErrorTemplate}" />
                </Style>

            </ControlTheme>

            <!-- TreeDataGridTemplateCell 样式 -->
            <ControlTheme x:Key="{x:Type TreeDataGridTemplateCell}" TargetType="TreeDataGridTemplateCell">
                <Setter Property="Template">
                    <ControlTemplate>
                        <ContentPresenter Name="PART_ContentPresenter"
                                          Background="{TemplateBinding Background}"
                                          BorderBrush="{TemplateBinding BorderBrush}"
                                          BorderThickness="{TemplateBinding BorderThickness}"
                                          ContentTemplate="{TemplateBinding ContentTemplate}"
                                          CornerRadius="{TemplateBinding CornerRadius}"
                                          Content="{TemplateBinding Content}"
                                          Padding="{TemplateBinding Padding}" />
                    </ControlTemplate>
                </Setter>

                <Style Selector="^:editing">
                    <Setter Property="Padding" Value="4 2" />
                    <Setter Property="Template">
                        <ControlTemplate>
                            <ContentPresenter Name="PART_EditingContentPresenter"
                                              Background="{TemplateBinding Background}"
                                              BorderBrush="{TemplateBinding BorderBrush}"
                                              BorderThickness="{TemplateBinding BorderThickness}"
                                              ContentTemplate="{TemplateBinding EditingTemplate}"
                                              CornerRadius="{TemplateBinding CornerRadius}"
                                              Content="{TemplateBinding Content}"
                                              Padding="{TemplateBinding Padding}" />
                        </ControlTemplate>
                    </Setter>
                </Style>
            </ControlTheme>
        </ResourceDictionary>
    </Styles.Resources>

    <!-- 单元格通用样式 -->
    <Style Selector=":is(TreeDataGridCell)">
        <Setter Property="Background" Value="Transparent" />
        <Setter Property="MinHeight" Value="25" />
    </Style>

    <!-- 单元格选中样式 -->
    <Style Selector=":is(TreeDataGridCell):selected">
        <Setter Property="Background" Value="{DynamicResource TreeDataGridSelectedCellBackgroundBrush}" />
    </Style>

    <!-- 
    行选中样式 (关键修复)
    当行被选中时，强制设置 HoverBorder 的背景色和不透明度
  -->
    <Style Selector="TreeDataGridRow:selected Border#HoverBorder">
        <Setter Property="Opacity" Value="1" />
        <Setter Property="Background" Value="{DynamicResource TreeRowSelectedBackground}" />
    </Style>

    <!-- 从 App.axaml 移动过来的样式 -->
    <Style Selector="Border.highlighted Border.field-badge">
        <Setter Property="Background" Value="Transparent" />
    </Style>
</Styles>