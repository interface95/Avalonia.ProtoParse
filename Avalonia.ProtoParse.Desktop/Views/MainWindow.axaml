<u:UrsaWindow xmlns="https://github.com/avaloniaui"
              xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
              xmlns:vm="using:Avalonia.ProtoParse.Desktop.ViewModels"
              xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
              xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
              xmlns:ae="using:AvaloniaEdit"
              xmlns:u="https://irihi.tech/ursa"
              xmlns:parser="clr-namespace:Protobuf.Decode.Parser"
              mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
              x:Class="Avalonia.ProtoParse.Desktop.Views.MainWindow"
              x:DataType="vm:MainWindowViewModel"
              Icon="/Assets/avalonia-logo.ico"
              Title="Avalonia.ProtoParse.Desktop"
              ExtendClientAreaToDecorationsHint="True"
              ExtendClientAreaChromeHints="PreferSystemChrome">

    <u:UrsaWindow.RightContent>
        <StackPanel Orientation="Horizontal"
                    Spacing="5">
            <u:IconButton Command="{Binding OpenNewWindowCommand}"
                          ToolTip.Tip="添加新窗口"
                          CornerRadius="10"
                          Theme="{StaticResource BorderlessIconButton}"
                          Icon="{StaticResource SemiIconCopyAdd}" />
            <u:ThemeToggleButton
                IsThreeState="True"
                Mode="Controller" />
        </StackPanel>

    </u:UrsaWindow.RightContent>

    <Design.DataContext>
        <!-- This only sets the DataContext for the previewer in an IDE,
             to set the actual DataContext for runtime, set the DataContext property in code (look at App.axaml.cs) -->
        <vm:MainWindowViewModel />
    </Design.DataContext>

    <u:LoadingContainer IsLoading="{Binding IsBusy}"
                        LoadingMessage="{Binding LoadingMessage}"
                        HorizontalContentAlignment="Stretch"
                        VerticalContentAlignment="Stretch">
        <!-- 
            主布局网格
            使用 Grid.IsSharedSizeScope="True" 允许子 Grid 共享尺寸组 (SharedSizeGroup)
            这用于同步三列标题的高度
        -->
        <Grid Grid.IsSharedSizeScope="True">
            <Grid.ColumnDefinitions>
                <!-- 左侧列：原始数据输入 -->
                <ColumnDefinition Width="320" MinWidth="300" />
                <!-- 分割线 -->
                <ColumnDefinition Width="1" />
                <!-- 中间列：结构树 -->
                <ColumnDefinition Width="*" MinWidth="300" />
                <!-- 分割线 -->
                <ColumnDefinition Width="1" />
                <!-- 右侧列：字段属性 -->
                <ColumnDefinition Width="300" MinWidth="250" />
            </Grid.ColumnDefinitions>

            <!-- 左侧列：输入区域 -->
            <Grid Grid.Column="0">
                <Grid.RowDefinitions>
                    <!-- 标题行：使用 SharedSizeGroup="HeaderHeight" 同步高度 -->
                    <RowDefinition Height="Auto" SharedSizeGroup="HeaderHeight" />
                    <!-- 编辑器区域 -->
                    <RowDefinition Height="*" />
                    <!-- 状态栏 -->
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>
                <!-- 标题栏 -->
                <Border Grid.Row="0" Margin="0,0,0,0" 
                        Padding="5,8" 
                        BorderBrush="#E1E3E5" 
                        BorderThickness="0,0,0,1">
                    <Grid ColumnDefinitions="Auto, *">
                        <TextBlock Text="原始数据" FontSize="16" FontWeight="Bold" VerticalAlignment="Center" Margin="20,0" />
                        <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" Spacing="8"
                                    Margin="0,0,5,0">
                            <Button Command="{Binding ParseCommand}" Classes="Primary" Padding="8,4" CornerRadius="4"
                                    HorizontalContentAlignment="Center" VerticalContentAlignment="Center">
                                <TextBlock Text="解&#x0a;析" TextAlignment="Center" FontSize="13" FontWeight="Bold" />
                            </Button>
                            <Button Command="{Binding ExampleCommand}" Padding="8,4" CornerRadius="4"
                                    HorizontalContentAlignment="Center"
                                    VerticalContentAlignment="Center">
                                <TextBlock Text="示&#x0a;例" TextAlignment="Center" FontSize="13" />
                            </Button>
                            <Button Command="{Binding ClearCommand}" Padding="8,4" CornerRadius="4"
                                    HorizontalContentAlignment="Center" VerticalContentAlignment="Center">
                                <TextBlock Text="清&#x0a;空" TextAlignment="Center" FontSize="13"
                                           Classes="Warning" />
                            </Button>
                            <Button Classes="Tertiary" Padding="8,4" CornerRadius="4"
                                    HorizontalContentAlignment="Center" VerticalContentAlignment="Center">
                                <TextBlock Text="导&#x0a;入" TextAlignment="Center" FontSize="13" />
                            </Button>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- 编辑器 -->
                <Border Grid.Row="1" BorderThickness="0,1,0,0" Margin="0">
                    <ae:TextEditor Name="InputEditor"
                                   ShowLineNumbers="False"
                                   WordWrap="True"
                                   HorizontalScrollBarVisibility="Disabled"
                                   FontFamily="Cascadia Code,Consolas,Monospace"
                                   Margin="10" />
                </Border>

                <!-- 状态栏 -->
                <Border Grid.Row="2" Padding="10,6">
                    <TextBlock Text="{Binding StatusText}" FontSize="12" Foreground="#6B7280" />
                </Border>
            </Grid>

            <!-- 分割线 1 -->
            <GridSplitter Grid.Column="1" ResizeDirection="Columns" />

            <!-- 中间列：结构树视图 -->
            <Grid Grid.Column="2">
                <Grid.RowDefinitions>
                    <!-- 标题行：同步高度 -->
                    <RowDefinition Height="Auto" SharedSizeGroup="HeaderHeight" />
                    <!-- 树形表格区域 -->
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>
                <!-- 标题栏 -->
                <Border Grid.Row="0" Padding="10,12" Margin="0,0,0,0" BorderBrush="#E1E3E5" BorderThickness="0,0,0,1">
                    <Grid ColumnDefinitions="Auto, Auto, *, Auto">
                        <TextBlock Text="结构树" FontSize="16" FontWeight="Bold" VerticalAlignment="Center"
                                   Margin="0,0,20,0" />

                        <!-- 操作按钮 -->
                        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="10">
                            <Button Content="全部展开" Command="{Binding ExpandAllCommand}" CornerRadius="4" Padding="15,6"
                                    FontSize="12" />
                            <Button Content="全部收缩" Command="{Binding CollapseAllCommand}" CornerRadius="4"
                                    Padding="15,6"
                                    FontSize="12" />
                            <Button Content="导出节点" CornerRadius="4" Padding="15,6" FontSize="12" />
                        </StackPanel>

                        <!-- 占位符 -->

                        <!-- 搜索框 -->
                        <TextBox Grid.Column="3" Watermark="搜索字符串" Width="200" CornerRadius="4" FontSize="12"
                                 VerticalAlignment="Center" Text="{Binding SearchText}" />
                    </Grid>
                </Border>

                <!-- 树形数据表格 -->
                <TreeDataGrid Grid.Row="1" Source="{Binding Source}" 
                              ShowColumnHeaders="False" 
                              Margin="0,10,0,0" />
            </Grid>

            <!-- 分割线 2 -->
            <GridSplitter Grid.Column="3" ResizeDirection="Columns" />

            <!-- 右侧列：字段属性面板 -->
            <Border Grid.Column="4" BorderBrush="#E1E3E5" BorderThickness="1,0,0,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <!-- 标题行：同步高度 -->
                        <RowDefinition Height="Auto" SharedSizeGroup="HeaderHeight" />
                        <!-- 属性详情区域 -->
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>
                    <Border Grid.Row="0" Padding="16,12" BorderBrush="#E1E3E5" BorderThickness="0,0,0,1">
                        <TextBlock Text="字段属性" FontSize="16" FontWeight="Bold" VerticalAlignment="Center" />
                    </Border>

                    <ScrollViewer Grid.Row="1">
                        <Panel>
                            <!-- 未选中节点时的提示 -->
                            <TextBlock Text="未选择节点。" IsVisible="{Binding !IsNodeSelected}" Foreground="#888"
                                       VerticalAlignment="Top" HorizontalAlignment="Center" Margin="0,20,0,0" />
                            
                            <!-- 选中节点时的详细信息 -->
                            <ContentControl Content="{Binding SelectedNode}" IsVisible="{Binding IsNodeSelected}">
                                <ContentControl.ContentTemplate>
                                    <DataTemplate DataType="parser:ProtoDisplayNode">
                                        <Grid RowDefinitions="Auto, Auto, Auto, Auto, *" ColumnDefinitions="100, *">
                                            <!-- PATH 字段 -->
                                            <Border Grid.Row="0" Grid.Column="0" Background="#F7F8FA"
                                                    BorderBrush="#E1E3E5" BorderThickness="0,0,1,1" Padding="12,10">
                                                <TextBlock Text="PATH" FontWeight="SemiBold" Foreground="#666"
                                                           VerticalAlignment="Center" FontSize="12" />
                                            </Border>
                                            <Border Grid.Row="0" Grid.Column="1" BorderBrush="#E1E3E5"
                                                    BorderThickness="0,0,0,1" Padding="12,10">
                                                <SelectableTextBlock Text="{Binding Path}" VerticalAlignment="Center"
                                                                     Foreground="#333" FontSize="13" />
                                            </Border>

                                            <!-- WIRETYPE 字段 -->
                                            <Border Grid.Row="1" Grid.Column="0" Background="#F7F8FA"
                                                    BorderBrush="#E1E3E5" BorderThickness="0,0,1,1" Padding="12,10">
                                                <TextBlock Text="WIRETYPE" FontWeight="SemiBold" Foreground="#666"
                                                           VerticalAlignment="Center" FontSize="12" />
                                            </Border>
                                            <Border Grid.Row="1" Grid.Column="1" BorderBrush="#E1E3E5"
                                                    BorderThickness="0,0,0,1" Padding="12,10">
                                                <SelectableTextBlock Text="{Binding WireTypeDisplay}"
                                                                     VerticalAlignment="Center" Foreground="#333"
                                                                     FontSize="13" />
                                            </Border>

                                            <!-- ARRAY 字段 (仅在 IsRepeated 为 True 时显示) -->
                                            <Border Grid.Row="2" Grid.Column="0" Background="#F7F8FA"
                                                    BorderBrush="#E1E3E5" BorderThickness="0,0,1,1" Padding="12,10"
                                                    IsVisible="{Binding IsRepeated}">
                                                <TextBlock Text="ARRAY" FontWeight="SemiBold" Foreground="#666"
                                                           VerticalAlignment="Center" FontSize="12" />
                                            </Border>
                                            <Border Grid.Row="2" Grid.Column="1" BorderBrush="#E1E3E5"
                                                    BorderThickness="0,0,0,1" Padding="12,10"
                                                    IsVisible="{Binding IsRepeated}">
                                                <StackPanel Orientation="Horizontal" Spacing="8">
                                                    <Border Background="#E6E8FA" CornerRadius="4" Padding="6,2">
                                                        <TextBlock Text="数组" Foreground="#5B5FC7" FontSize="11" />
                                                    </Border>
                                                    <SelectableTextBlock
                                                        Text="{Binding OccurrenceIndex, StringFormat='#{0}'}"
                                                        VerticalAlignment="Center" Foreground="#5B5FC7"
                                                        FontWeight="Bold" FontSize="13" />
                                                </StackPanel>
                                            </Border>

                                            <!-- TEXT 字段 (仅在有 Utf8Preview 时显示) -->
                                            <Border Grid.Row="3" Grid.Column="0" Background="#F7F8FA"
                                                    BorderBrush="#E1E3E5" BorderThickness="0,0,1,1" Padding="12,10"
                                                    IsVisible="{Binding Utf8Preview, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                                                <TextBlock Text="TEXT" FontWeight="SemiBold" Foreground="#666"
                                                           VerticalAlignment="Top" FontSize="12" />
                                            </Border>
                                            <Border Grid.Row="3" Grid.Column="1" BorderBrush="#E1E3E5"
                                                    BorderThickness="0,0,0,1" Padding="12,10"
                                                    IsVisible="{Binding Utf8Preview, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                                                <SelectableTextBlock Text="{Binding Utf8Preview}" Foreground="#333"
                                                                     TextWrapping="Wrap" FontSize="13" />
                                            </Border>

                                            <!-- HEX 字段 -->
                                            <Border Grid.Row="4" Grid.Column="0" Background="#F7F8FA"
                                                    BorderBrush="#E1E3E5" BorderThickness="0,0,1,1" Padding="12,10">
                                                <TextBlock Text="HEX" FontWeight="SemiBold" Foreground="#666"
                                                           VerticalAlignment="Top" FontSize="12" />
                                            </Border>
                                            <Border Grid.Row="4" Grid.Column="1" BorderBrush="#E1E3E5"
                                                    BorderThickness="0,0,0,1" Padding="12,10">
                                                <SelectableTextBlock Text="{Binding RawPreview}"
                                                                     FontFamily="Cascadia Code,Consolas,Monospace"
                                                                     Foreground="#333" TextWrapping="Wrap"
                                                                     LineHeight="18" FontSize="12" />
                                            </Border>
                                        </Grid>
                                    </DataTemplate>
                                </ContentControl.ContentTemplate>
                            </ContentControl>
                        </Panel>
                    </ScrollViewer>
                </Grid>
            </Border>

        </Grid>
    </u:LoadingContainer>

</u:UrsaWindow>